<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Upload</title>
</head>
<body>
  <h1>อัปโหลดรูป</h1>

  <form id="uploadForm" onsubmit="return false;">
    <div>
      <label>ชื่องาน: <input id="title" type="text" required></label>
    </div>
    <div>
      <label>รายละเอียด: <textarea id="description"></textarea></label>
    </div>
    <div>
      <label>เลือกรูป: <input id="fileInput" type="file" accept="image/*" required></label>
    </div>
    <button type="button" id="uploadBtn">อัปโหลด</button>
  </form>

  <p id="status"></p>

 <script>
  async function uploadFile(file) {
    const q = new URLSearchParams({
      filename: file.name,
      filetype: file.type || 'application/octet-stream',
    });

    const presignRes = await fetch(`/upload/presign?${q.toString()}`, { method: 'PUT' });
    if (!presignRes.ok) {
      const err = await presignRes.json().catch(() => ({}));
      throw new Error(err.error || 'presign failed');
    }
    const { uploadUrl, key } = await presignRes.json();

    const putRes = await fetch(uploadUrl, {
      method: 'PUT',
      headers: { 'Content-Type': file.type || 'application/octet-stream' },
      body: file,
    });

    if (!putRes.ok) throw new Error('S3 upload failed');

    document.getElementById('status').textContent = 'อัปโหลดสำเร็จ!';
    console.log('Uploaded to:', key);
  }

  // เพิ่ม event listener ให้ปุ่ม
  document.getElementById('uploadBtn').addEventListener('click', async () => {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    if (!file) {
      document.getElementById('status').textContent = 'กรุณาเลือกไฟล์';
      return;
    }
    document.getElementById('status').textContent = 'กำลังอัปโหลด...';
    try {
      await uploadFile(file);
    } catch (err) {
      document.getElementById('status').textContent = 'เกิดข้อผิดพลาด: ' + err.message;
    }
  });
</script>

</body>
</html>
